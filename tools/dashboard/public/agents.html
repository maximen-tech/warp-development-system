<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Agents & Skills - Pro Dashboard</title>
    <!-- Design System CSS (Phase 6) -->
    <link rel="stylesheet" href="/css/design-system.css" />
    <link rel="stylesheet" href="/css/layout.css" />
    <link rel="stylesheet" href="/css/components.css" />
    <link rel="stylesheet" href="/css/animations.css" />
    <link rel="stylesheet" href="/css/responsive.css" />
    <!-- Legacy Styles -->
    <link rel="stylesheet" href="/styles.css" />
    <link rel="stylesheet" href="/agents-pro.css" />
    <script src="/quickbar.js" defer></script>
    <script src="/ux-suite.js" defer></script>
    <style>
      .tabs{display:flex;gap:8px;margin:12px 0}
      .tab{padding:8px 16px;border:1px solid var(--border);border-radius:999px;cursor:pointer;font-weight:500;transition:all 0.2s;background:transparent}
      .tab.active{background:var(--info);color:#000;border-color:var(--info);box-shadow:0 2px 8px rgba(106,183,255,0.3);transform:scale(1.05)}
      .tab:hover:not(.active){border-color:var(--info);background:rgba(106,183,255,0.1)}
      .chips{display:flex;gap:6px;flex-wrap:wrap}
      .chip{border:1px solid var(--border);padding:2px 6px;border-radius:999px}
      .modal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:1000}
      .modal .content{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:16px;min-width:360px;max-width:720px}
      .grid-cards{display:grid;gap:12px;grid-template-columns:repeat(3,1fr)}
      .kv{display:grid;grid-template-columns:140px 1fr;gap:8px;align-items:center;margin:6px 0}
      .kv input, .kv select, .kv textarea{width:100%}
      .err-cell{background-color:rgba(255,0,0,.15);border:1px solid var(--warn)}
      .err-hint{color:var(--warn);font-size:0.8em;margin-top:2px}
      .imp-batch{background:var(--panel);padding:8px;border:1px solid var(--border);border-radius:6px;margin:8px 0}
      @media(max-width:900px){ .grid-cards{grid-template-columns:1fr} }
    </style>
  </head>
  <body>
    <header>
      <a class="pill" href="/">‚Üê Back</a>
      <strong>Agents & Skills</strong>
      <span class="pill" id="reloadAgents">Reload</span>
      <span class="pill" id="historyBtn">History</span>
      <span class="pill" id="exportAgents">Export (YAML)</span>
      <span class="pill" id="changelogBtn">Changelog</span>
      <span class="pill" id="marketBtn">Marketplace</span>
    </header>
    <div class="wrap">
      <!-- Modern Tabs -->
      <div class="tabs" style="display:flex;gap:8px;margin:12px 0">
        <div class="tab active" data-tab="agents" style="padding:8px 16px;border:1px solid var(--border);border-radius:999px;cursor:pointer;font-weight:500;transition:all 0.2s">ü§ñ Agents</div>
        <div class="tab" data-tab="skills" style="padding:8px 16px;border:1px solid var(--border);border-radius:999px;cursor:pointer;font-weight:500;transition:all 0.2s">‚ö° Skills</div>
      </div>

      <!-- Professional Toolbar -->
      <div class="agents-toolbar">
        <div class="toolbar-section">
          <input id="search" class="search-input" placeholder="Search agents, skills, models..." />
        </div>
        <div class="toolbar-divider"></div>
        <div class="toolbar-section">
          <select id="roleFilter" class="select-custom">
            <option value="">All roles</option>
            <option>planner</option>
            <option>executor</option>
            <option>validator</option>
            <option>custom</option>
          </select>
          <select id="healthFilter" class="select-custom">
            <option value="">All health</option>
            <option value="healthy">‚úì Healthy</option>
            <option value="stale">‚ö† Stale</option>
          </select>
          <select id="sortBy" class="select-custom">
            <option value="manual">Sort: Manual</option>
            <option value="errors">Sort: Errors ‚Üì</option>
            <option value="calls">Sort: Calls ‚Üì</option>
            <option value="latency">Sort: Latency ‚Üì</option>
            <option value="skills">Sort: Skills ‚Üì</option>
            <option value="name">Sort: Name A‚ÜíZ</option>
          </select>
        </div>
        <div class="toolbar-divider"></div>
        <div class="toolbar-section">
          <label class="toggle-switch">
            <input type="checkbox" id="autoExpandErr" />
            <span>Auto-expand errors</span>
          </label>
        </div>
        <div class="toolbar-divider"></div>
        <div class="toolbar-section">
          <button id="addBtn" class="action-btn primary">+ Add Agent</button>
          <button id="reloadAgents" class="action-btn">üîÑ Reload</button>
          <button id="exportAgents" class="action-btn">üì• Export All</button>
          <button id="bulkExportJson" class="action-btn">üì¶ Export Selected</button>
          <label class="action-btn" for="bulkImport" style="margin:0">üì§ Import</label>
          <input id="bulkImport" type="file" accept="application/json,.csv" style="display:none" />
          <button id="bulkDelete" class="action-btn danger">üóë Delete</button>
          <button id="bulkDuplicate" class="action-btn">üìã Duplicate</button>
          <button id="historyUI" class="action-btn">üïê History</button>
          <button id="changelogBtn" class="action-btn">üìú Changelog</button>
          <button id="marketBtn" class="action-btn">üõí Marketplace</button>
        </div>
      </div>

      <div id="agentsView">
        <div class="agents-grid" id="agentCards"></div>
      </div>
      <div id="skillsView" style="display:none">
        <div class="agents-grid" id="skillCards"></div>
      </div>
      <div id="onboarding" class="card" style="display:none;margin-top:12px">
        <div><b>Welcome</b> ‚Äî Create your first agent and skill</div>
        <div class="small">Step 1: Add an agent. Step 2: Attach a skill. Step 3: Configure guardrails and approvals.</div>
        <div class="row" style="margin-top:8px"><button class="pill" id="createSample">Create sample</button></div>
      </div>
    </div>

    <!-- Diff & Rollback Modal -->
    <div class="modal" id="diffModal" style="display:none">
      <div class="content">
        <div class="row" style="justify-content:space-between;align-items:center">
          <strong>Diff & Rollback</strong>
          <button class="pill" onclick="closeModal('#diffModal')">Close</button>
        </div>
        <div class="row" style="gap:8px">
          <select id="backupSelect" class="pill"></select>
          <button class="pill" id="loadDiff">Load diff</button>
          <button class="pill" id="doRollback">Rollback</button>
        </div>
        <div class="grid" style="grid-template-columns:1fr 1fr; gap:8px">
          <div class="card"><div class="small">Before</div><pre id="diffBefore" class="small" style="white-space:pre-wrap;max-height:40vh;overflow:auto"></pre></div>
          <div class="card"><div class="small">After</div><pre id="diffAfter" class="small" style="white-space:pre-wrap;max-height:40vh;overflow:auto"></pre></div>
        </div>
        <pre id="diffOut" class="small" style="white-space:pre-wrap;max-height:30vh;overflow:auto"></pre>
      </div>
    </div>

    <!-- Import Wizard Modal -->
    <div class="modal" id="importModal" style="display:none">
      <div class="content">
        <div class="row" style="justify-content:space-between;align-items:center"><strong>Import Wizard</strong><button class="pill" onclick="closeModal('#importModal')">Close</button></div>
        <div id="dropzone" class="card" style="padding:12px;border-style:dashed">Drag & drop JSON/CSV here or use toolbar Import JSON</div>
        <div class="small" id="importStatus"></div>
        <div id="importTable" class="small" style="max-height:40vh;overflow:auto"></div>
        <div class="row" style="gap:8px;align-items:center;justify-content:flex-end"><progress id="importProgress" max="100" value="0" style="width:180px"></progress><button class="pill" id="applyImport" disabled>Apply selected</button></div>
      </div>
    </div>

    <!-- Changelog Modal -->
    <div class="modal" id="changelogModal" style="display:none">
      <div class="content" style="max-width:900px">
        <div class="row" style="justify-content:space-between;align-items:center"><strong>Changelog</strong><button class="pill" onclick="closeModal('#changelogModal')">Close</button></div>
        <div class="small">Last changes:</div>
        <div id="chgList" class="small" style="max-height:50vh;overflow:auto"></div>
      </div>
    </div>

    <!-- Marketplace Modal -->
    <div class="modal" id="marketModal" style="display:none">
      <div class="content" style="max-width:700px">
        <div class="row" style="justify-content:space-between;align-items:center"><strong>Import skills by URL</strong><button class="pill" onclick="closeModal('#marketModal')">Close</button></div>
        <div class="row" style="gap:8px"><input id="marketUrl" class="pill" placeholder="https://... (JSON or YAML)" style="min-width:420px"/><button class="pill" id="marketPreview">Preview</button><button class="pill" id="marketApply" disabled>Import</button></div>
        <div id="marketStatus" class="small"></div>
        <div id="marketTable" class="small" style="max-height:40vh;overflow:auto"></div>
      </div>
    </div>

    <!-- Connectors Modal (Pro-grade tile-based) -->
    <div class="modal-overlay" id="connModal">
      <div class="modal-container" style="max-width:800px">
        <div class="modal-header">
          <div class="modal-title">üîå Connectors</div>
          <button class="modal-close" onclick="closeModal('#connModal')">√ó</button>
        </div>
        <div class="modal-body">
          <div class="connectors-grid">
            <!-- GitHub Connector Tile -->
            <div class="connector-tile" id="githubTile">
              <div class="connector-header">
                <div class="connector-icon github">
                  <svg width="24" height="24" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.012 8.012 0 0 0 16 8c0-4.42-3.58-8-8-8z"/>
                  </svg>
                </div>
                <div class="connector-title">GitHub</div>
                <div class="connector-status inactive" id="githubStatus">Not configured</div>
              </div>
              <input id="connGithubRepo" class="connector-input" placeholder="owner/repo" />
              <input id="connGithubToken" class="connector-input" type="password" placeholder="{{GITHUB_TOKEN}}" />
              <div class="connector-feedback" id="githubFeedback"></div>
            </div>

            <!-- Slack Connector Tile -->
            <div class="connector-tile" id="slackTile">
              <div class="connector-header">
                <div class="connector-icon slack">
                  <svg width="24" height="24" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M3.362 10.11c0 .926-.756 1.681-1.681 1.681S0 11.036 0 10.111C0 9.186.756 8.43 1.68 8.43h1.682v1.68zm.846 0c0-.924.756-1.68 1.681-1.68s1.681.756 1.681 1.68v4.21c0 .924-.756 1.68-1.68 1.68a1.685 1.685 0 0 1-1.682-1.68v-4.21zM5.89 3.362c-.926 0-1.682-.756-1.682-1.681S4.964 0 5.89 0s1.68.756 1.68 1.68v1.682H5.89zm0 .846c.924 0 1.68.756 1.68 1.681S6.814 7.57 5.89 7.57H1.68C.757 7.57 0 6.814 0 5.89c0-.926.756-1.682 1.68-1.682h4.21zm6.749 1.682c0-.926.755-1.682 1.68-1.682.925 0 1.681.756 1.681 1.681s-.756 1.681-1.68 1.681h-1.681V5.89zm-.848 0c0 .924-.755 1.68-1.68 1.68A1.685 1.685 0 0 1 8.43 5.89V1.68C8.43.757 9.186 0 10.11 0c.926 0 1.681.756 1.681 1.68v4.21zm-1.681 6.748c.926 0 1.682.756 1.682 1.681S11.036 16 10.11 16s-1.681-.756-1.681-1.68v-1.682h1.68zm0-.847c-.924 0-1.68-.755-1.68-1.68 0-.925.756-1.681 1.68-1.681h4.21c.924 0 1.68.756 1.68 1.68 0 .926-.756 1.681-1.68 1.681h-4.21z"/>
                  </svg>
                </div>
                <div class="connector-title">Slack</div>
                <div class="connector-status inactive" id="slackStatus">Not configured</div>
              </div>
              <input id="connSlack" class="connector-input" type="url" placeholder="https://hooks.slack.com/services/..." />
              <div class="connector-feedback" id="slackFeedback"></div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="action-btn" onclick="closeModal('#connModal')">Cancel</button>
          <button class="action-btn" id="connTest">üß™ Test Connections</button>
          <button class="action-btn primary" id="connSave">‚úì Save</button>
        </div>
      </div>
    </div>

    <!-- Details Drawer Modal -->
    <div class="modal" id="detailsModal" style="display:none">
      <div class="content" style="max-width:900px">
        <div class="row" style="justify-content:space-between;align-items:center"><strong id="detailsTitle">Agent details</strong><button class="pill" onclick="closeModal('#detailsModal')">Close</button></div>
        <div class="grid" style="grid-template-columns: 1fr 1fr; gap:12px">
          <div class="card"><div class="row" style="justify-content:space-between"><div class="small">Status</div><button class="pill" id="detJumpRuns">Open runs</button></div><pre id="detStatus" class="small"></pre></div>
          <div class="card"><div class="small">Logs</div><pre id="detLogs" class="small" style="max-height:200px;overflow:auto"></pre></div>
          <div class="card"><div class="small">KPI (last 60m)</div><div class="row" style="gap:8px"><canvas id="detKpiSpark" width="260" height="60"></canvas><div class="small" id="detKpiStats"></div></div><div class="row" style="gap:8px"><button class="pill" id="detExportKpi">Export JSON</button></div></div>
          <div class="card" style="grid-column:1/3"><div class="small">Timeline (recent)</div><pre id="detTimeline" class="small" style="max-height:200px;overflow:auto"></pre></div>
        </div>
      </div>
    </div>

    <div class="modal" id="editorModal">
      <div class="content">
        <div class="row" style="justify-content:space-between;align-items:center">
          <strong id="modalTitle">Edit</strong>
          <button class="pill" id="closeModal">Close</button>
        </div>
        <div id="form"></div>
        <div class="small" id="validation" style="margin-top:8px"></div>
        <div class="row" style="justify-content:flex-end;margin-top:12px">
          <button class="pill" id="testBtn" style="display:none">Test agent</button>
          <button class="pill" id="saveBtn">Save</button>
        </div>
      </div>
    </div>

    <script>
      const activeProject = (function(){ try{ return JSON.parse(localStorage.getItem('active_project')||'null'); }catch{ return null; } })();
      const activeProjectPath = activeProject && activeProject.path || '';
      const activeProjectId = activeProject && activeProject.id || '';

      const S = { agents: [], skills: [], status:{}, filter:'', timers:{}, sortBy: (localStorage.getItem('agents.sortBy')||'manual'), autoExpandErr: (localStorage.getItem('agents.autoExpandErr')==='1'), errSeen: {}, lastAutoExpandTs: 0, importBatch: null, importErrors: {} };
      const qs = (s,el=document)=>el.querySelector(s);
      const qsa = (s,el=document)=>Array.from(el.querySelectorAll(s));
      function showModal(on){ qs('#editorModal').style.display = on?'flex':'none'; }

      // Lightweight modal helper for other modals (supports both old and new styles)
      function openModal(id){ const m = qs(id); if(m){ if(m.classList.contains('modal-overlay')){ m.classList.add('show'); } else { m.style.display='flex'; } } }
      function closeModal(id){ const m = qs(id); if(m){ if(m.classList.contains('modal-overlay')){ m.classList.remove('show'); } else { m.style.display='none'; } } }

      async function loadAll(){
        const qp = activeProjectPath ? `?projectPath=${encodeURIComponent(activeProjectPath)}` : '';
        const list = await (await fetch('/api/agents/list'+qp)).json();
        S.agents = list.agents||[]; S.skills = list.skills||[]; await refreshStatus(); render();
      }
      async function refreshStatus(){ try{ S.status = (await (await fetch('/api/agents/status')).json()).status || {}; } catch{ S.status = {}; } }

      function render(){
        const f = (S.filter||'').toLowerCase();
        const rf = (qs('#roleFilter')?.value||'');
        const hf = (qs('#healthFilter')?.value||'');
        // agents
        const g = qs('#agentCards'); g.innerHTML='';
        let list = S.agents.slice().filter(a=>{
          if(f){ const hay = [a.name,a.role,a.model,(a.skills||[]).join(' ')].join(' ').toLowerCase(); if(!hay.includes(f)) return false; }
          if(rf && a.role!==rf) return false;
          if(hf){ const s = S.status[a.name]||{}; const isHealthy = !!s.healthy; if(hf==='healthy' && !isHealthy) return false; if(hf==='stale' && isHealthy) return false; }
          return true;
        });
        // sort
        const sb = S.sortBy||'manual';
        const metric = (a)=>{ const s=S.status[a.name]||{}; return { errors: s.errors||0, calls: s.calls||0, lat: s.avgLatencyMs||0, skills: (a.skills||[]).length }; };
        if(sb==='name'){ list.sort((a,b)=> (a.name||'').localeCompare(b.name||'')); }
        else if(sb==='errors'){ list.sort((a,b)=> metric(b).errors - metric(a).errors || (a.name||'').localeCompare(b.name||'')); }
        else if(sb==='calls'){ list.sort((a,b)=> metric(b).calls - metric(a).calls || (a.name||'').localeCompare(b.name||'')); }
        else if(sb==='latency'){ list.sort((a,b)=> metric(b).lat - metric(a).lat || (a.name||'').localeCompare(b.name||'')); }
        else if(sb==='skills'){ list.sort((a,b)=> metric(b).skills - metric(a).skills || (a.name||'').localeCompare(b.name||'')); }
        // render cards (Pro-grade design)
        for(const a of list){
          const card = document.createElement('div');
          card.className = 'agent-card' + (a.on===false ? ' off' : '');
          card.draggable = true;
          card.dataset.name = a.name||'';
          
          const st = S.status[a.name]||{};
          const healthClass = st.healthy ? 'healthy' : 'stale';
          const hasConnectors = a.connectors && (a.connectors.github || a.connectors.slack);
          const initials = (a.name||'?').substring(0,2).toUpperCase();
          
          card.innerHTML = `
            <div class="agent-card-header">
              <div class="agent-avatar">${initials}</div>
              <div class="agent-info">
                <div class="agent-name">
                  <span class="agent-name-text">${a.name||'(unnamed)'}</span>
                  ${a.on===false ? '<span class="status-badge error">off</span>' : ''}
                </div>
                <div class="agent-meta">
                  <span>${a.role||'-'}</span>
                  <span class="agent-meta-separator">‚Ä¢</span>
                  <span>${a.model||'-'}</span>
                </div>
              </div>
              <input type="checkbox" data-select style="margin-left:auto" />
            </div>
            
            <div class="skills-list">
              ${(a.skills||[]).length > 0 ? (a.skills||[]).map(s=>`<span class="skill-chip">${s}</span>`).join('') : '<span class="skills-empty">No skills attached</span>'}
            </div>
            
            <div class="agent-stats">
              <div class="stat-item">
                <span class="stat-value" data-calls>0</span>
                <span class="stat-label">Calls</span>
              </div>
              <div class="stat-item">
                <span class="stat-value" data-errors>0</span>
                <span class="stat-label">Errors</span>
              </div>
              <div class="stat-item">
                <span class="stat-value" data-lat>0ms</span>
                <span class="stat-label">Latency</span>
              </div>
              <div class="stat-item">
                <span class="stat-value" data-last>-</span>
                <span class="stat-label">Last</span>
              </div>
            </div>
            
            <div style="display:flex;gap:6px;margin:12px 0;flex-wrap:wrap">
              <span class="status-badge ${healthClass}">${healthClass}</span>
              ${hasConnectors ? '<span class="status-badge connected">connected</span>' : ''}
            </div>
            
            <div class="agent-actions">
              <button class="action-btn primary" data-act="expand">üîç Details</button>
              <button class="action-btn" data-act="edit">‚úè Edit</button>
              <button class="action-btn" data-act="test">üß™ Test</button>
              <button class="action-btn" data-act="connectors">üîå Connect</button>
              <button class="action-btn" data-act="copyjson">üìã Copy</button>
              <button class="action-btn" data-act="export">üì• Export</button>
              <button class="action-btn danger" data-act="delete">üóë Delete</button>
            </div>
          `;
          
          card.querySelector('[data-act="expand"]').onclick = ()=> expandAgent(card, a);
          card.querySelector('[data-act="edit"]').onclick = ()=> openEditor('agent', a);
          card.querySelector('[data-act="test"]').onclick = ()=> testAgent(a);
          card.querySelector('[data-act="connectors"]').onclick = ()=> openConnectors(a);
          card.querySelector('[data-act="copyjson"]').onclick = async ()=>{ await navigator.clipboard.writeText(JSON.stringify(a,null,2)); if(window.showToast) showToast('Agent copied to clipboard', 'success'); };
          card.querySelector('[data-act="export"]').onclick = async ()=>{ const t = await (await fetch(`/api/agents/export-one?name=${encodeURIComponent(a.name)}&format=yaml`)).text(); const blob = new Blob([t],{type:'text/plain'}); const link = document.createElement('a'); link.href=URL.createObjectURL(blob); link.download=`agent_${a.name}.yml`; link.click(); if(window.showToast) showToast('Agent exported', 'success'); };
          card.querySelector('[data-act="delete"]').onclick = ()=> deleteAgent(a);
          
          g.appendChild(card);
        }
        // skills (Pro design)
        const sg = qs('#skillCards'); sg.innerHTML='';
        for(const s of S.skills){
          if(f){ const hay = [s.name,s.description].join(' ').toLowerCase(); if(!hay.includes(f)) continue; }
          const attachedCount = S.agents.reduce((acc,a)=> acc + ((a.skills||[]).includes(s.name)?1:0), 0);
          const card = document.createElement('div');
          card.className = 'agent-card';
          card.dataset.name = s.name||'';
          const initials = (s.name||'?').substring(0,2).toUpperCase();
          
          card.innerHTML = `
            <div class="agent-card-header">
              <div class="agent-avatar" style="background:linear-gradient(135deg, var(--warn) 0%, var(--info) 100%)">${initials}</div>
              <div class="agent-info">
                <div class="agent-name">
                  <span class="agent-name-text">${s.name||'(unnamed)'}</span>
                </div>
                <div class="agent-meta">
                  <span>${attachedCount} agent${attachedCount!==1?'s':''} attached</span>
                </div>
              </div>
            </div>
            
            <div style="margin:12px 0;color:#9fb3c8;font-size:14px;line-height:1.5">
              ${(s.description||'No description').slice(0,160)}${(s.description||'').length>160?'...':''}
            </div>
            
            <div class="agent-actions">
              <button class="action-btn primary" data-act="edit">‚úè Edit</button>
              <button class="action-btn" data-act="copyjson">üìã Copy JSON</button>
              <button class="action-btn" data-act="export">üì• Export</button>
              <button class="action-btn danger" data-act="delete">üóë Delete</button>
            </div>
          `;
          
          card.querySelector('[data-act="copyjson"]').onclick = async ()=>{ await navigator.clipboard.writeText(JSON.stringify(s,null,2)); if(window.showToast) showToast('Skill copied to clipboard', 'success'); };
          card.querySelector('[data-act="export"]').onclick = async ()=>{ const t = await (await fetch(`/api/skills/export-one?name=${encodeURIComponent(s.name)}&format=yaml`)).text(); const blob = new Blob([t],{type:'text/plain'}); const link = document.createElement('a'); link.href=URL.createObjectURL(blob); link.download=`skill_${s.name}.yml`; link.click(); if(window.showToast) showToast('Skill exported', 'success'); };
          card.querySelector('[data-act="edit"]').onclick = ()=> openEditor('skill', s);
          card.querySelector('[data-act="delete"]').onclick = ()=> { if(attachedCount>0 && !confirm('Skill is attached to '+attachedCount+' agent(s). Detach and delete?')) return; deleteSkill(s); };
          sg.appendChild(card);
        }
        enableDrag();
      }

      function enableDrag(){
        const container = qs('#agentCards');
        qsa('.agent-card', container).forEach(c=>{
          c.addEventListener('dragstart', e=>{ e.dataTransfer.setData('text/plain', c.dataset.name); });
        });
        container.addEventListener('dragover', e=>{ e.preventDefault(); });
        container.addEventListener('drop', e=>{
          e.preventDefault(); const name = e.dataTransfer.getData('text/plain'); const el = qsa('.agent-card', container).find(x=>x.dataset.name===name); const target = e.target.closest('.agent-card'); if(!el || !target || el===target) return; container.insertBefore(el, target);
          // persist order to S and save
          const order = qsa('.agent-card', container).map(x=>x.dataset.name);
          S.agents.sort((a,b)=> order.indexOf(a.name)-order.indexOf(b.name));
          validateAndMaybeSave(true);
        });
      }

      function openEditor(kind, obj){
        S.editKind = kind; S.editObj = JSON.parse(JSON.stringify(obj||{}));
        qs('#modalTitle').textContent = (obj&&obj.name? 'Edit ':'Create ') + (kind==='agent'?'agent':'skill');
        const form = qs('#form'); form.innerHTML='';
        if(kind==='agent'){
          form.appendChild(kv('Name','text','name'));
          form.appendChild(kv('Role','select','role',['planner','executor','validator','custom']));
          form.appendChild(kv('Model','text','model'));
          form.appendChild(kvSkills('Skills','skills'));
          form.appendChild(kv('On/Off','selectBool','on'));
          form.appendChild(kv('Limits (json)','textarea','limits'));
          form.appendChild(kv('Guardrails (json)','textarea','guardrails'));
          form.appendChild(kvPolicy());
          form.appendChild(kvApprovals());
          qs('#testBtn').style.display=''; qs('#testBtn').onclick = ()=> testAgent(S.editObj);
        } else {
          form.appendChild(kv('Name','text','name'));
          form.appendChild(kv('Description','textarea','description'));
          form.appendChild(kv('Inputs (json)','textarea','inputs'));
          form.appendChild(kv('Outputs (json)','textarea','outputs'));
          form.appendChild(kv('Props (json)','textarea','props'));
          form.appendChild(kvAgentsAttach());
          qs('#testBtn').style.display='none';
        }
        bindForm(form, S.editObj);
        showModal(true);
        validateLive();
      }

      function kvAgentsAttach(){
        const wrap = document.createElement('div'); wrap.className='kv';
        wrap.innerHTML = `<label class=\"small\">Attached agents</label><div></div>`; const div = wrap.children[1];
        for(const ag of S.agents){ const row = document.createElement('div'); row.className='row'; const cb = document.createElement('input'); cb.type='checkbox'; cb.dataset.agent=ag.name; const lab=document.createElement('span'); lab.textContent = ag.name; row.appendChild(cb); row.appendChild(lab); div.appendChild(row); }
        return wrap;
      }
      function kvPolicy(){
        const wrap = document.createElement('div'); wrap.className='kv';
        wrap.innerHTML = `<label class=\"small\">Policy</label><div></div>`; const div=wrap.children[1];
        const sel = document.createElement('select'); sel.dataset.field='policy_preset'; ['Custom','Safe','Balanced','Autonomous'].forEach(p=>{ const o=document.createElement('option'); o.value=p; o.textContent=p; sel.appendChild(o); });
        sel.onchange = ()=>{
          const p = sel.value; const obj = S.editObj; obj.approvals = obj.approvals || {};
          if(p==='Safe'){ obj.approvals.required = true; obj.approvals.autonomy = 0; obj.guardrails = obj.guardrails||{ blockedCommands:['rm -rf','drop database'] }; }
          else if(p==='Balanced'){ obj.approvals.required = true; obj.approvals.autonomy = 1; obj.guardrails = obj.guardrails||{ reviewRequired:['write files','git push'] }; }
          else if(p==='Autonomous'){ obj.approvals.required = false; obj.approvals.autonomy = 3; obj.guardrails = obj.guardrails||{ auditOnly:true }; }
          S.saveReason = 'policy-change';
          validateLive();
        };
        div.appendChild(sel);
        const pyr = document.createElement('div'); pyr.className='small'; pyr.innerText = '‚ñ≤\n‚ñ≤‚ñ≤\n‚ñ≤‚ñ≤‚ñ≤'; pyr.style.cursor='pointer'; pyr.title='Click rows to set autonomy 0-2, bottom = 3'; pyr.onclick = (e)=>{ const y = e.offsetY; const h = e.target.clientHeight||30; const ratio = y/h; const lvl = ratio<0.33? 0 : (ratio<0.66? 1 : 2); const obj=S.editObj; obj.approvals=obj.approvals||{}; obj.approvals.autonomy = lvl; S.saveReason='policy-change'; validateLive(); }; div.appendChild(pyr);
        return wrap;
      }
      function kvApprovals(){
        const wrap = document.createElement('div'); wrap.className='kv';
        wrap.innerHTML = `<label class="small">Approvals</label><div></div>`; const div = wrap.children[1];
        const row = document.createElement('div'); row.className='row'; row.style.gap='8px';
        const req = document.createElement('select'); ['false','true'].forEach(v=>{ const o=document.createElement('option'); o.value=v; o.textContent = (v==='true'?'Required':'Not required'); req.appendChild(o); }); req.dataset.field='approvals_required';
        const slider = document.createElement('input'); slider.type='range'; slider.min='0'; slider.max='3'; slider.step='1'; slider.style.width='120px'; slider.dataset.field='approvals_autonomy';
        const val = document.createElement('span'); val.className='small'; val.textContent='autonomy 0';
        slider.oninput = ()=>{ val.textContent = `autonomy ${slider.value}`; };
        row.appendChild(req); row.appendChild(slider); row.appendChild(val);
        div.appendChild(row);
        const adv = document.createElement('textarea'); adv.rows=3; adv.dataset.field='approvals_json'; adv.placeholder='Advanced JSON for approvals'; div.appendChild(adv);
        return wrap;
      }

      function kv(label, type, field, opts){
        const wrap = document.createElement('div'); wrap.className='kv';
        wrap.innerHTML = `<label class="small">${label}</label><div></div>`; const inputWrap = wrap.children[1];
        let el;
        if(type==='text'){ el = document.createElement('input'); el.type='text'; el.value=''; }
        else if(type==='textarea'){ el = document.createElement('textarea'); el.rows=3; el.value=''; }
        else if(type==='select'){ el = document.createElement('select'); for(const o of (opts||[])){ const opt=document.createElement('option'); opt.value=o; opt.textContent=o; el.appendChild(opt);} }
        else if(type==='selectBool'){ el = document.createElement('select'); for(const [v,t] of [[true,'On'],[false,'Off']]){ const opt=document.createElement('option'); opt.value=v; opt.textContent=t; el.appendChild(opt);} }
        inputWrap.appendChild(el);
        el.dataset.field = field; return wrap;
      }
      function kvSkills(label, field){
        const wrap = document.createElement('div'); wrap.className='kv';
        wrap.innerHTML = `<label class="small">${label}</label><div></div>`; const inputWrap = wrap.children[1];
        const select = document.createElement('select'); select.multiple=true; select.size=5; select.style.minHeight='100px';
        for(const s of S.skills){ const opt = document.createElement('option'); opt.value=s.name; opt.textContent=s.name; select.appendChild(opt); }
        inputWrap.appendChild(select); select.dataset.field = field; return wrap;
      }
      function bindForm(form, obj){
        // skill attached agents
        if(S.editKind==='skill'){
          const checks = qsa('[data-agent]', form); const usedBy = new Set(); for(const ag of S.agents){ if((ag.skills||[]).includes(obj.name)) usedBy.add(ag.name); }
          checks.forEach(cb=>{ cb.checked = usedBy.has(cb.dataset.agent); cb.onchange = ()=>{ const ag = S.agents.find(x=>x.name===cb.dataset.agent); if(!ag) return; ag.skills = ag.skills||[]; if(cb.checked){ if(!ag.skills.includes(obj.name)) ag.skills.push(obj.name); } else { ag.skills = ag.skills.filter(n=>n!==obj.name); } validateLive(); } });
        }
        // init approvals
        const appr = obj.approvals || {};
        const reqSel = form.querySelector('[data-field="approvals_required"]'); if(reqSel){ reqSel.value = String(!!appr.required); reqSel.onchange = ()=> updateFromForm(form, obj); }
        const slider = form.querySelector('[data-field="approvals_autonomy"]'); if(slider){ slider.value = String(Number.isInteger(appr.autonomy)? appr.autonomy:0); const next = slider.nextSibling; if(next && next.classList) next.textContent = `autonomy ${slider.value}`; slider.onchange = ()=> updateFromForm(form, obj); slider.oninput = ()=>{ const next = slider.nextSibling; if(next && next.classList) next.textContent = `autonomy ${slider.value}`; } }
        const adv = form.querySelector('[data-field="approvals_json"]'); if(adv){ adv.value = appr && Object.keys(appr).length? JSON.stringify(appr, null, 2): ''; adv.oninput = ()=> updateFromForm(form, obj); }

        qsa('[data-field]', form).forEach(el=>{
          const f = el.dataset.field;
          // initialize
          if(el.tagName==='SELECT' && el.multiple){ const set = new Set(obj[f]||[]); Array.from(el.options).forEach(o=>{ o.selected = set.has(o.value); }); }
          else if(el.tagName==='SELECT' && el.options.length && (el.dataset.field==='on')){ const v = (obj.on!==false); el.value = String(v); }
          else if(el.tagName==='SELECT'){ el.value = (obj[f]||'') }
          else if(el.tagName==='TEXTAREA'){ const v = obj[f] ? JSON.stringify(obj[f], null, 2) : ''; el.value = v; }
          else { el.value = obj[f]||''; }
          el.oninput = ()=> updateFromForm(form, obj);
          el.onchange = ()=> updateFromForm(form, obj);
        });
      }
      function openConnectors(agent){
        // Open modal with new class
        const modal = qs('#connModal');
        modal.classList.add('show');
        
        const ghRepo=qs('#connGithubRepo'), ghTok=qs('#connGithubToken'), slack=qs('#connSlack');
        const ghFeedback=qs('#githubFeedback'), slackFeedback=qs('#slackFeedback');
        const ghStatus=qs('#githubStatus'), slackStatus=qs('#slackStatus');
        const ghTile=qs('#githubTile'), slackTile=qs('#slackTile');
        
        // Reset all tile states (BUG FIX #6)
        ghTile.classList.remove('active');
        slackTile.classList.remove('active');
        ghStatus.classList.remove('active');
        ghStatus.classList.add('inactive');
        slackStatus.classList.remove('active');
        slackStatus.classList.add('inactive');
        ghFeedback.classList.remove('show', 'success', 'error');
        slackFeedback.classList.remove('show', 'success', 'error');
        
        // Work on a copy to avoid mutation on cancel (BUG FIX #8)
        S.editConnAgent = agent;
        S.editConnCopy = JSON.parse(JSON.stringify(agent.connectors || {}));
        
        const cfg = S.editConnCopy;
        ghRepo.value = cfg.github?.repo||'';
        ghTok.value = cfg.github?.token||'';
        slack.value = cfg.slack?.webhook||'';
        
        // Update status badges
        ghStatus.textContent = 'Not configured';
        slackStatus.textContent = 'Not configured';
        if(cfg.github?.repo && cfg.github?.token){
          ghStatus.textContent = 'Configured';
          ghStatus.classList.remove('inactive');
          ghStatus.classList.add('active');
          ghTile.classList.add('active');
        }
        if(cfg.slack?.webhook){
          slackStatus.textContent = 'Configured';
          slackStatus.classList.remove('inactive');
          slackStatus.classList.add('active');
          slackTile.classList.add('active');
        }
        
        const testBtn = qs('#connTest');
        testBtn.onclick = async ()=>{
          // Add loading state (BUG FIX #7)
          testBtn.disabled = true;
          testBtn.textContent = '‚è≥ Testing...';
          
          ghFeedback.textContent = 'Testing...';
          ghFeedback.classList.remove('success', 'error');
          ghFeedback.classList.add('show');
          slackFeedback.textContent = 'Testing...';
          slackFeedback.classList.remove('success', 'error');
          slackFeedback.classList.add('show');
          
          try{
            const j = await (await fetch('/api/connectors/test',{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ type:'multi', config:{ github:{ repo: ghRepo.value, token: ghTok.value }, slack:{ webhook: slack.value } } })})).json();
            
            if(j.ok){
              ghFeedback.textContent = '‚úì GitHub connection successful';
              ghFeedback.classList.add('success');
              slackFeedback.textContent = '‚úì Slack connection successful';
              slackFeedback.classList.add('success');
            } else {
              ghFeedback.textContent = '‚úó Test failed: ' + (j.error||'Unknown error');
              ghFeedback.classList.add('error');
              slackFeedback.textContent = '‚úó Test failed';
              slackFeedback.classList.add('error');
            }
          }catch(err){
            ghFeedback.textContent = '‚úó Connection failed';
            ghFeedback.classList.add('error');
            slackFeedback.textContent = '‚úó Connection failed';
            slackFeedback.classList.add('error');
          } finally {
            // Restore button state
            testBtn.disabled = false;
            testBtn.textContent = 'üß™ Test Connections';
          }
        };
        
        const saveBtn = qs('#connSave');
        saveBtn.onclick = async ()=>{
          // Update copy then apply to original (BUG FIX #8)
          S.editConnAgent.connectors = { github:{ repo: ghRepo.value, token: ghTok.value }, slack:{ webhook: slack.value } };
          saveBtn.disabled = true;
          saveBtn.textContent = '‚è≥ Saving...';
          try{
            await fetch('/api/agents/item',{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ agent: S.editConnAgent }) });
            modal.classList.remove('show');
            if(window.showToast) showToast('Connectors saved successfully', 'success');
            await loadAll();
          } catch(err) {
            if(window.showToast) showToast('Save failed: ' + err.message, 'error');
          } finally {
            saveBtn.disabled = false;
            saveBtn.textContent = '‚úì Save';
          }
        };
      }

      function updateFromForm(form, obj){
        qsa('[data-field]', form).forEach(el=>{
          const f = el.dataset.field;
          if(f==='approvals_required'){ obj.approvals = obj.approvals || {}; obj.approvals.required = (el.value==='true'); }
          else if(f==='approvals_autonomy'){ obj.approvals = obj.approvals || {}; obj.approvals.autonomy = parseInt(el.value,10); }
          else if(f==='approvals_json'){ try{ const j = el.value.trim()? JSON.parse(el.value): {}; obj.approvals = { ...(obj.approvals||{}), ...j }; }catch{} }
          else if(el.tagName==='SELECT' && el.multiple){ obj[f] = Array.from(el.selectedOptions).map(o=>o.value); }
          else if(el.tagName==='SELECT' && (f==='on')){ obj.on = (el.value==='true'); }
          else if(el.tagName==='SELECT'){ obj[f] = el.value; }
          else if(el.tagName==='TEXTAREA'){ try{ obj[f] = el.value.trim()? JSON.parse(el.value): undefined; }catch{ /* keep as previous until valid */ } }
          else { obj[f] = el.value; }
        });
        validateLive();
      }

      async function validateLive(){
        const previewAgents = S.editKind==='agent' ? mergeEdited(S.agents, S.editObj) : S.agents;
        const previewSkills = S.editKind==='skill' ? mergeEdited(S.skills, S.editObj) : S.skills;
        try{
          const r = await fetch('/api/agents/validate-json',{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ agents: previewAgents, skills: previewSkills }) });
          const j = await r.json();
          qs('#validation').textContent = j.ok? 'Valid ‚úì' : ('Errors: '+ (j.errors||[]).map(e=>e.file+': '+e.error).join(' | '));
          return j.ok;
        } catch{ qs('#validation').textContent = 'Validation error'; return false; }
      }
      function mergeEdited(list, obj){ const i = list.findIndex(x=>x.name===obj.name); if(i>=0){ const copy = list.slice(); copy[i] = obj; return copy; } else { return [...list, obj]; } }

      async function validateAndMaybeSave(silent){
        const ok = await validateLive(); if(!ok && !silent){ if(window.showToast) showToast('Please fix validation errors', 'warning'); return; }
        if(silent) return;
        const res = await fetch('/api/agents/save',{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ agents:S.agents, skills:S.skills, reason: (S.saveReason||null), projectPath: activeProjectPath||'' }) }); S.saveReason=null;
        const j = await res.json(); if(!j.ok){ if(window.showToast) showToast('Save failed', 'error'); return; }
        await fetch('/api/agents/reload',{ method:'POST' });
        showModal(false); await loadAll();
        if(!silent && window.showToast) showToast('Changes saved successfully', 'success');
      }

      async function saveEdit(){
        if(S.editKind==='agent'){
          const i = S.agents.findIndex(x=>x.name===S.editObj.name);
          if(i>=0) S.agents[i] = S.editObj; else S.agents.push(S.editObj);
        } else {
          const i = S.skills.findIndex(x=>x.name===S.editObj.name);
          if(i>=0) S.skills[i] = S.editObj; else S.skills.push(S.editObj);
        }
        await validateAndMaybeSave(false);
      }

      async function deleteAgent(a){ if(!confirm('Delete agent '+(a.name||'')+'?')) return; S.agents = S.agents.filter(x=>x!==a); await validateAndMaybeSave(false); }
      async function deleteSkill(s){ if(!confirm('Delete skill '+(s.name||'')+'?')) return; S.skills = S.skills.filter(x=>x!==s); // detach from agents
        for(const ag of S.agents){ ag.skills = (ag.skills||[]).filter(n=>n!==s.name); }
        await validateAndMaybeSave(false);
      }

      async function testAgent(a){ const prompt = window.prompt('Test prompt','Hello'); if(prompt===null) return; try{ const res = await fetch('/api/agents/test',{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ agent:a.name, prompt, projectPath: activeProjectPath||'' }) }); const j = await res.json(); if(window.showToast) showToast('Test triggered successfully', 'success', 3000, 'Agent Test'); if(j && j.output){ console.log('[agent-test]', j.output); } }catch(err){ if(window.showToast) showToast('Test failed: '+err.message, 'error'); } }
      async function expandAgent(card, a){
        openModal('#detailsModal');
        qs('#detailsTitle').textContent = `Agent: ${a.name}`;
        // status
        try { const st = (await (await fetch('/api/agents/status?window=3600')).json()).status || {}; const s = st[a.name] || {}; qs('#detStatus').textContent = JSON.stringify(s, null, 2); } catch { qs('#detStatus').textContent = 'status unavailable'; }
        // logs/timeline
        try{ const j = await (await fetch(`/api/agents/logs?agent=${encodeURIComponent(a.name)}&limit=100`)).json(); const lines = (j.events||[]).map(ev=>`${new Date((ev.ts||0)*1000).toLocaleTimeString()} ${ev.kind||''} ${ev.status||''}`); qs('#detLogs').textContent = lines.join('\n')||'No logs'; qs('#detTimeline').textContent = lines.slice(-50).join('\n'); }catch{ qs('#detLogs').textContent='No logs'; qs('#detTimeline').textContent=''; }
        // KPI
        try{ const k = await (await fetch(`/api/agents/kpi?agent=${encodeURIComponent(a.name)}&window=3600`)).json(); const m = k.metrics||{}; const stats = `calls=${m.calls||0} errors=${m.errors||0} success=${((m.successRate||0)*100).toFixed(0)}% latency=${Math.round(m.avgLatencyMs||0)}ms medianWait=${(m.medianTimeToApprovalSec||0).toFixed(1)}s`; qs('#detKpiStats').textContent=stats; const series = Array.isArray(m.sparklinePerMin)? m.sparklinePerMin: []; const canvas = qs('#detKpiSpark'); if(canvas){ const ctx=canvas.getContext('2d'); ctx.clearRect(0,0,canvas.width,canvas.height); if(series.length){ const max = Math.max(1, ...series); ctx.strokeStyle=getComputedStyle(document.documentElement).getPropertyValue('--info'); ctx.beginPath(); series.forEach((v,i)=>{ const x = i*(canvas.width/Math.max(1,(series.length-1))); const y = canvas.height - (v/max)*canvas.height; if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y); }); ctx.stroke(); } }
          qs('#detExportKpi').onclick = ()=>{ const blob = new Blob([JSON.stringify(k,null,2)],{type:'application/json'}); const ael=document.createElement('a'); ael.href=URL.createObjectURL(blob); ael.download=`kpi_${a.name}.json`; ael.click(); };
          qs('#detJumpRuns').onclick = ()=>{ window.location.href = `/runs.html?agent=${encodeURIComponent(a.name)}`; };
        }catch{}
      }

      // events
      qsa('.tab').forEach(t=>{ t.onclick = ()=>{ qsa('.tab').forEach(x=>x.classList.remove('active')); t.classList.add('active'); const tab=t.dataset.tab; qs('#agentsView').style.display = tab==='agents'?'':'none'; qs('#skillsView').style.display = tab==='skills'?'':'none'; qs('#addBtn').textContent = tab==='agents'? '+ Add Agent':'+ Add Skill'; }; });
      qs('#addBtn').onclick = ()=> openEditor(qs('.tab.active').dataset.tab==='agents'?'agent':'skill', { name:'', role:'custom', model:'', skills:[], approvals:{ required:false, autonomy:0 } });
      qs('#search').oninput = (e)=>{ S.filter = e.target.value; render(); };
      qs('#roleFilter').onchange = ()=> render();
      qs('#healthFilter').onchange = ()=> render();
      // sort + auto-expand prefs
      const sortEl = qs('#sortBy'); if(sortEl){ sortEl.value = S.sortBy||'manual'; sortEl.onchange = ()=>{ S.sortBy = sortEl.value; localStorage.setItem('agents.sortBy', S.sortBy); render(); }; }
      const autoEl = qs('#autoExpandErr'); if(autoEl){ autoEl.checked = !!S.autoExpandErr; autoEl.onchange = ()=>{ S.autoExpandErr = !!autoEl.checked; localStorage.setItem('agents.autoExpandErr', S.autoExpandErr ? '1':'0'); }; }
      qs('#reloadAgents').onclick = async ()=>{ try{ await fetch('/api/agents/reload',{ method:'POST' }); if(window.showToast) showToast('Agents reloaded', 'success'); await loadAll(); }catch(err){ if(window.showToast) showToast('Reload failed', 'error'); } };
      qs('#historyBtn').onclick = async ()=>{ openModal('#diffModal'); try{ const h = await (await fetch('/api/agents/history')).json(); const sel = qs('#backupSelect'); sel.innerHTML=''; for(const b of (h.backups||[])){ const o=document.createElement('option'); o.value=b.name; o.textContent = `${new Date(b.ts).toLocaleString()} ¬∑ ${b.name}`; sel.appendChild(o); } }catch{} };
      qs('#changelogBtn').onclick = ()=>{ openModal('#changelogModal'); };
      (function(){ const src = new EventSource('/agents-changes'); const list = document.getElementById('chgList'); src.onmessage = (e)=>{ try{ const ev = JSON.parse(e.data); const div = document.createElement('div'); div.textContent = `[${new Date((ev.ts||0)*1000).toLocaleTimeString()}] ${ev.kind} ${JSON.stringify(ev.details||{})}`; const btn = document.createElement('button'); btn.className='pill'; btn.textContent='Undo this'; btn.onclick = async ()=>{ const d = ev.details||{}; const names=[]; if(d.beforeAgents) names.push(d.beforeAgents); if(d.beforeSkills) names.push(d.beforeSkills); if(!names.length) return alert('No backup to rollback to for this entry'); await fetch('/api/agents/rollback-group',{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ names }) }); await loadAll(); }; const row = document.createElement('div'); row.className='row'; row.style.justifyContent='space-between'; row.appendChild(div); row.appendChild(btn); list.prepend(row); }catch{} }; })();
      qs('#historyUI').onclick = async ()=>{ openModal('#diffModal'); try{ const h = await (await fetch('/api/agents/history')).json(); const sel = qs('#backupSelect'); sel.innerHTML=''; for(const b of (h.backups||[])){ const o=document.createElement('option'); o.value=b.name; o.textContent = `${new Date(b.ts).toLocaleString()} ¬∑ ${b.name}`; sel.appendChild(o); } }catch{} };
      qs('#loadDiff').onclick = async ()=>{ const name = qs('#backupSelect').value; if(!name) return; const d = await (await fetch(`/api/agents/diff?name=${encodeURIComponent(name)}`)).json(); qs('#diffOut').textContent = (d.agentsDiff||'') + (d.skillsDiff? ('\n'+d.skillsDiff) : ''); const txt = await (await fetch(`/api/agents/backup-content?name=${encodeURIComponent(name)}`)).text(); const isAgents = name.startsWith('agents'); const curAgents = isAgents ? (await (await fetch('/api/agents')).json()).agents : ''; const curSkills = isAgents ? '' : (await (await fetch('/api/agents')).json()).skills; qs('#diffBefore').textContent = txt; qs('#diffAfter').textContent = isAgents? curAgents : curSkills; };
      qs('#doRollback').onclick = async ()=>{ const name = qs('#backupSelect').value; if(!name) return; if(!confirm('Rollback to '+name+'?')) return; await fetch('/api/agents/rollback-group',{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ names:[name] }) }); closeModal('#diffModal'); await loadAll(); };
      qs('#exportAgents').onclick = async ()=>{ const qp = activeProjectPath? `?format=json&projectPath=${encodeURIComponent(activeProjectPath)}` : '?format=json'; const j = await (await fetch('/api/agents/export'+qp)).json(); const blob = new Blob([JSON.stringify(j,null,2)],{type:'application/json'}); const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='agents_export.json'; a.click(); };
      qs('#bulkExportJson').onclick = async ()=>{
        const selected = Array.from(document.querySelectorAll('[data-select]:checked')).map(cb=>cb.closest('.agent-card')?.dataset?.name).filter(Boolean);
        let url = '/api/agents/export?format=json';
        if(selected.length) url += `&names=${encodeURIComponent(selected.join(','))}`;
        if(activeProjectPath) url += `&projectPath=${encodeURIComponent(activeProjectPath)}`;
        const j = await (await fetch(url)).json(); const blob = new Blob([JSON.stringify(j,null,2)],{type:'application/json'}); const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='agents_selected.json'; a.click();
      };
      qs('#bulkImport').onchange = async (e)=>{ const file = e.target.files[0]; if(!file) return; openModal('#importModal'); const status = qs('#importStatus'); const table = qs('#importTable'); status.textContent='Parsing...'; let payload=null; try{ const textRaw = await file.text(); const text = textRaw.replace(/\uFEFF/, ''); // strip BOM
          // simple delimiter sniff
          const delim = (text.includes(';') && text.split('\n')[0].split(';').length > 1) ? ';' : (text.includes('\t') ? '\t' : ',');
          if(file.type==='application/json' || text.trim().startsWith('{') || text.trim().startsWith('[')){ payload = JSON.parse(text); } else { // naive CSV to agents list
            const rows = text.split(/\r?\n/).filter(Boolean).map(r=>r.split(delim)); const head = rows.shift()||[]; const idxName=head.indexOf('name'), idxRole=head.indexOf('role'), idxModel=head.indexOf('model'), idxSkills=head.indexOf('skills'); const agents=[]; for(const r of rows){ agents.push({ name:r[idxName], role:r[idxRole], model:r[idxModel], skills:(r[idxSkills]||'').split('|').filter(Boolean) }); } payload={ agents }; }
          // Preview table
          const agents = Array.isArray(payload.agents)? payload.agents: []; const skills = Array.isArray(payload.skills)? payload.skills: [];
          const rows = [];
          rows.push('<div><b>Agents</b></div>'); rows.push('<table class="small"><tr><th><input type="checkbox" id="selAllAgents"/></th><th>Name</th><th>Role</th><th>Model</th><th>Skills</th></tr>');
          agents.forEach((a,i)=>{ rows.push(`<tr><td><input type=checkbox data-kind=agent data-index=${i} checked/></td><td>${a.name||''}</td><td>${a.role||''}</td><td>${a.model||''}</td><td>${(a.skills||[]).join(',')}</td></tr>`); }); rows.push('</table>');
          rows.push('<div style="margin-top:8px"><b>Skills</b></div>'); rows.push('<table class="small"><tr><th><input type="checkbox" id="selAllSkills"/></th><th>Name</th><th>Description</th></tr>');
          skills.forEach((s,i)=>{ rows.push(`<tr><td><input type=checkbox data-kind=skill data-index=${i} checked/></td><td>${s.name||''}</td><td>${(s.description||'').slice(0,60)}</td></tr>`); }); rows.push('</table>');
          table.innerHTML = rows.join('');
          const getSelection = ()=>{ const selAgents = []; const selSkills=[]; qsa('[data-kind=agent]:checked', table).forEach(cb=> selAgents.push(agents[parseInt(cb.dataset.index,10)])); qsa('[data-kind=skill]:checked', table).forEach(cb=> selSkills.push(skills[parseInt(cb.dataset.index,10)])); return { agents: selAgents, skills: selSkills } };
          const validateSel = async ()=>{ const sel = getSelection(); const dry = await (await fetch('/api/agents/validate-json',{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ agents: sel.agents, skills: sel.skills }) })).json(); status.textContent = dry.ok? 'Valid ‚úì' : 'Errors: '+(dry.errors||[]).map(e=>e.file+': '+e.error).join(' | '); qs('#applyImport').disabled = !dry.ok; };
          qsa('input[type=checkbox]', table).forEach(cb=> cb.onchange = validateSel);
          qs('#selAllAgents')?.addEventListener('change', (ev)=>{ const on = ev.target.checked; qsa('[data-kind=agent]', table).forEach(cb=> cb.checked=on); validateSel(); });
          qs('#selAllSkills')?.addEventListener('change', (ev)=>{ const on = ev.target.checked; qsa('[data-kind=skill]', table).forEach(cb=> cb.checked=on); validateSel(); });
          await validateSel();
          qs('#applyImport').onclick = async ()=>{ const sel = getSelection(); // dry-run
            const dry = await (await fetch('/api/agents/import',{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ agents: sel.agents, skills: sel.skills, partial:true, dryRun:true, projectPath: activeProjectPath||'' }) })).json(); if(!dry.ok){ status.textContent='Errors: '+JSON.stringify(dry.errors); return; }
            const prog = document.getElementById('importProgress'); let v=0; prog.value=0; const t = setInterval(()=>{ v=Math.min(100, v+10); prog.value=v; }, 200);
            const res = await (await fetch('/api/agents/import',{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ agents: sel.agents, skills: sel.skills, partial:true, dryRun:false, projectPath: activeProjectPath||'' }) })).json(); clearInterval(t); prog.value=100; if(!res.ok){ status.textContent='Apply failed'; return; }
            closeModal('#importModal'); await loadAll();
          };
        } catch{ status.textContent='Invalid file'; } };

      // Drag & drop importer
      (function(){ const dz = document.getElementById('dropzone'); if(!dz) return; dz.ondragover = (e)=>{ e.preventDefault(); dz.style.borderColor='var(--info)'; }; dz.ondragleave = ()=>{ dz.style.borderColor='var(--border)'; }; dz.ondrop = async (e)=>{ e.preventDefault(); dz.style.borderColor='var(--border)'; const f = e.dataTransfer.files[0]; if(!f) return; const input = document.getElementById('bulkImport'); input.files = e.dataTransfer.files; input.onchange({ target: input }); }; })();

      // Marketplace flow
      document.getElementById('marketBtn').onclick = ()=> openModal('#marketModal');
      document.getElementById('marketPreview').onclick = async ()=>{ const url = document.getElementById('marketUrl').value.trim(); const status = document.getElementById('marketStatus'); const table = document.getElementById('marketTable'); status.textContent='Fetching...'; table.innerHTML=''; try{ const j = await (await fetch('/api/skills/import-url',{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ url })})).json(); if(!j.ok) { status.textContent='Error'; return; } const skills = j.skills||[]; const rows = []; rows.push('<table class="small"><tr><th><input type=checkbox id=mkAll checked/></th><th>Name</th><th>Description</th></tr>'); skills.forEach((s,i)=> rows.push(`<tr><td><input type=checkbox data-mk=${i} checked/></td><td>${s.name}</td><td>${(s.description||'').slice(0,80)}</td></tr>`)); rows.push('</table>'); table.innerHTML = rows.join(''); status.textContent = `Found ${skills.length} skills`; document.getElementById('marketApply').disabled = skills.length===0; document.getElementById('mkAll').onchange = (ev)=>{ const on = ev.target.checked; qsa('[data-mk]', table).forEach(cb=> cb.checked=on); }; document.getElementById('marketApply').onclick = async ()=>{ const sel=[]; qsa('[data-mk]:checked', table).forEach(cb=> sel.push(skills[parseInt(cb.dataset.mk,10)])); if(!sel.length) return; // dry-run validate
          const dry = await (await fetch('/api/agents/validate-json',{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ agents: S.agents, skills: [...S.skills, ...sel] })})).json(); if(!dry.ok){ status.textContent='Validation errors: '+(dry.errors||[]).map(e=>e.file).join(', '); return; }
          const res = await (await fetch('/api/agents/import',{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ skills: sel, partial:true, dryRun:false }) })).json(); if(!res.ok){ status.textContent = 'Import failed'; return; } closeModal('#marketModal'); await loadAll(); };
        }catch{ status.textContent='Fetch failed'; } };
      qs('#bulkDelete').onclick = async ()=>{ const selected = Array.from(document.querySelectorAll('[data-select]:checked')).map(cb=>cb.closest('.agent-card')?.dataset?.name).filter(Boolean); if(!selected.length) return alert('No selection'); if(!confirm('Delete '+selected.length+' agents?')) return; for(const name of selected){ const qp = activeProjectPath? `?name=${encodeURIComponent(name)}&projectPath=${encodeURIComponent(activeProjectPath)}` : `?name=${encodeURIComponent(name)}`; await fetch(`/api/agents/item${qp}`,{ method:'DELETE' }); } await loadAll(); };
      qs('#bulkDuplicate').onclick = async ()=>{ const selected = Array.from(document.querySelectorAll('[data-select]:checked')).map(cb=>cb.closest('.agent-card')?.dataset?.name).filter(Boolean); if(!selected.length) return alert('No selection'); const list = S.agents.filter(a=>selected.includes(a.name)); for(const a of list){ const copy = JSON.parse(JSON.stringify(a)); copy.name = a.name+'-copy'; await fetch('/api/agents/item',{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ agent: copy }) }); } await loadAll(); };
      qs('#closeModal').onclick = ()=> showModal(false);
      qs('#saveBtn').onclick = saveEdit;
      qs('#createSample')?.addEventListener('click', async ()=>{ const sampleSkill = { name:'echo', description:'Echo input', inputs:{ text:'string' }, outputs:{ text:'string' } }; const sampleAgent = { name:'agent-1', role:'executor', model:'local', skills:['echo'], approvals:{ required:false, autonomy:1 } }; S.skills.push(sampleSkill); S.agents.push(sampleAgent); await validateAndMaybeSave(false); });

      async function refreshAnalytics(){ try{ const st = await (await fetch('/api/agents/status?window=3600')).json(); S.status = st.status||{}; Array.from(document.querySelectorAll('#agentCards .agent-card')).forEach(card=>{ const name = card.dataset.name; const s = S.status[name]||{}; const callsEl = card.querySelector('[data-calls]'); const errorsEl = card.querySelector('[data-errors]'); const lastEl = card.querySelector('[data-last]'); const latEl = card.querySelector('[data-lat]'); if(callsEl) callsEl.textContent = s.calls||0; if(errorsEl) errorsEl.textContent = s.errors||0; if(lastEl) lastEl.textContent = s.lastTs? new Date(s.lastTs*1000).toLocaleTimeString() : '-'; if(latEl) latEl.textContent = s.avgLatencyMs? `${Math.round(s.avgLatencyMs)}ms` : '0ms'; });
          // auto-expand on new errors (rate-limited)
          if(S.autoExpandErr){ const now = Date.now(); let opened=false; for(const [name,s] of Object.entries(S.status)){
            const prev = S.errSeen[name]||0; const cur = s.errors||0; if(!opened && cur>prev && cur>0 && (now - (S.lastAutoExpandTs||0) > 15000)){
              const agent = S.agents.find(x=>x.name===name); if(agent){ expandAgent(null, agent); S.lastAutoExpandTs = now; opened=true; }
            }
            S.errSeen[name] = cur;
          } }
        }catch{} }
      S.timers.analytics = setInterval(refreshAnalytics, 5000);
      function updateOnboarding(){ const empty = (!S.agents.length && !S.skills.length); const o = qs('#onboarding'); if(o) o.style.display = empty? '':'none'; }
      const _loadAll = loadAll; loadAll = async function(){ await _loadAll(); updateOnboarding(); refreshAnalytics(); };

      loadAll();
      const _render = render; render = function(){ const prev = S.filter; S.filter = document.getElementById('search').value; const role = document.getElementById('roleFilter')?.value||''; const health = document.getElementById('healthFilter')?.value||''; const orig = S.agents.slice(); _render(); Array.from(document.querySelectorAll('#agentCards .agent-card')).forEach(card=>{ const name = card.dataset.name; const a = orig.find(x=>x.name===name); let show = true; if(role && a?.role!==role) show=false; const st = S.status[name]||{}; if(health==='healthy' && !st.healthy) show=false; if(health==='stale' && st.healthy) show=false; card.style.display = show? '':'none'; }); S.filter = prev; };

      // Hotkeys: undo/redo
      document.addEventListener('keydown', async (e)=>{
        if(e.ctrlKey && (e.key==='z' || e.key==='Z')){ e.preventDefault(); try{ const r = await (await fetch('/api/agents/undo',{ method:'POST' })).json(); if(r.ok) await loadAll(); }catch{} }
        if(e.ctrlKey && (e.key==='y' || e.key==='Y')){ e.preventDefault(); try{ const r = await (await fetch('/api/agents/redo',{ method:'POST' })).json(); if(r.ok) await loadAll(); }catch{} }
      });

      loadAll();
    </script>
  </body>
</html>
