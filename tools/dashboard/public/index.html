<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Warp Dashboard</title>
    <style>
      body { font-family: system-ui, sans-serif; margin: 0; padding: 0; background: #0b0f14; color: #e6edf3; }
      header { padding: 12px 16px; background: #151b23; border-bottom: 1px solid #263040; display:flex; gap:12px; align-items:center; }
      .wrap { padding: 16px; }
      .event { padding: 8px 12px; background: #11161d; border: 1px solid #263040; border-radius: 8px; margin-bottom: 8px; }
      .ts { color: #9fb3c8; font-size: 12px; }
      .ok { color: #27d980; }
      .warn { color: #ffc857; }
      .err { color: #ff6b6b; }
      .info { color: #6ab7ff; }
      .action { font-weight: 600; }
      .msg { opacity: .9; }
      .controls { display:flex; gap:8px; align-items:center; }
      .pill { padding:4px 8px; border:1px solid #263040; border-radius:999px; background:#0b0f14; color:#e6edf3; cursor:pointer; }
      .pill.active { background:#263040; }
      input[type="file"] { display:none; }
      label[for="snapshot"] { cursor:pointer; }
    </style>
  </head>
  <body>
    <header>
<strong>Warp Dashboard</strong>
      <a class="pill" href="/agents.html" style="text-decoration:none;">Agents</a>
      <div class="controls">
        <span class="pill" id="toggle-await">Awaiting approvals</span>
        <span class="pill" id="toggle-errors">Errors</span>
        <label class="pill" for="snapshot">Load snapshot</label>
        <input id="snapshot" type="file" accept=".jsonl,.log,text/plain" />
      </div>
    </header>
    <div class="wrap">
      <div style="margin-bottom:12px;">
        <input id="filter" placeholder="Filter by kind/phase/agent/status/message" style="width:100%;padding:8px;border-radius:6px;border:1px solid #263040;background:#0b0f14;color:#e6edf3;"/>
      </div>
      <div id="list"></div>
    </div>
    <script>
      const list = document.getElementById('list');
      const filter = document.getElementById('filter');
      const toggleAwait = document.getElementById('toggle-await');
      const toggleErrors = document.getElementById('toggle-errors');
      const snapshot = document.getElementById('snapshot');
      let showAwait = false, showErrors = false;

      function toMessage(ev){
        const d = ev.data||{};
        if(ev.kind==='action_proposed') return `cmd=${JSON.stringify(d.cmd||[])} approval=${d.approval}`;
        if(ev.kind==='transition') return `node=${(d.node||'')}`;
        if(ev.kind==='agent_request') return `profile=${(d.profile||'')}`;
        if(ev.kind==='agent_response') return `usage=${JSON.stringify(d.usage||{})}`;
        if(ev.kind==='validation_summary') return `bullets=${(d.len||0)}`;
        return JSON.stringify(d);
      }

      function statusClass(ev){
        if(ev.status==='error') return 'err';
        if(ev.status==='awaiting_approval') return 'warn';
        if(ev.status==='validated' || ev.kind==='end') return 'ok';
        return 'info';
      }

      function render(ev) {
        // filter toggles
        if(showAwait && ev.status!=='awaiting_approval') return;
        if(showErrors && ev.status!=='error') return;
        const div = document.createElement('div');
        div.className = 'event';
        const sClass = statusClass(ev);
        const msg = toMessage(ev).replace(/</g,'&lt;');
        const ts = ev.ts ? new Date(ev.ts*1000).toISOString() : '';
        div.innerHTML = `
          <div class="ts">${ts}</div>
          <div><span class="action">${ev.kind||''}</span> · <span class="${sClass}">${ev.status||''}</span> · <span>${ev.phase||''}</span> · <span>${ev.agent||''}</span></div>
          <div class="msg">${msg}</div>
        `;
        div.dataset.search = `${(ev.kind||'')} ${(ev.phase||'')} ${(ev.agent||'')} ${(ev.status||'')} ${msg}`.toLowerCase();
        list.prepend(div);
      }

      // Live stream
      const source = new EventSource('/events');
      source.onmessage = (e) => { try { render(JSON.parse(e.data)); } catch {} };
      source.onerror = () => {
        const div = document.createElement('div');
        div.className = 'event';
        div.innerHTML = '<div class="msg err">Lost connection to server...</div>';
        list.prepend(div);
      };

      // Local snapshot loader (no server required)
      snapshot.addEventListener('change', async () => {
        const f = snapshot.files[0]; if(!f) return;
        const text = await f.text();
        for(const line of text.split(/\r?\n/)){
          if(!line.trim()) continue;
          try { render(JSON.parse(line)); } catch {}
        }
      });

      // Text filter
      filter.addEventListener('input', () => {
        const q = filter.value.toLowerCase();
        for (const el of list.children) el.style.display = el.dataset.search.includes(q) ? '' : 'none';
      });

      // Toggle pills
      toggleAwait.addEventListener('click', ()=>{ showAwait=!showAwait; toggleAwait.classList.toggle('active', showAwait); });
      toggleErrors.addEventListener('click', ()=>{ showErrors=!showErrors; toggleErrors.classList.toggle('active', showErrors); });
    </script>
  </body>
</html>
