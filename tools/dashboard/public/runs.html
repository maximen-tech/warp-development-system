<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Warp Runs</title>
    <link rel="stylesheet" href="/styles.css" />
  </head>
  <body>
    <header>
      <a class="pill" href="/">← Back</a>
      <strong>Runs</strong>
    </header>
    <div class="wrap">
      <div class="grid" style="grid-template-columns: 1fr 2fr;">
        <div class="card">
          <div class="row" style="justify-content:space-between;">
            <span>Run segments</span>
            <div class="row" style="gap:8px">
              <input id="agentFilter" class="pill" placeholder="Filter by agent (optional)"/>
              <button id="refresh" class="pill">Refresh</button>
            </div>
          </div>
          <div id="runs"></div>
        </div>
        <div class="card">
          <div class="row" style="justify-content:space-between;">
            <span>Events</span>
            <a id="download" class="pill" href="#">Download</a>
          </div>
          <pre id="events" class="small" style="white-space:pre-wrap"></pre>
        </div>
      </div>
    </div>
    <script>
      const runsEl = document.getElementById('runs');
      const eventsEl = document.getElementById('events');
      const downloadEl = document.getElementById('download');
      const agentInput = document.getElementById('agentFilter');
      // Read query param agent
      const qp = new URLSearchParams(location.search);
      const preAgent = qp.get('agent')||''; if(preAgent){ agentInput.value = preAgent; }
      function highlightAgent(text, agent){ if(!agent) return text; try{ return text.split(/\n/).map(l=> l.includes(`"agent":"${agent}`) ? `> ${l}` : l).join('\n'); }catch{return text} }
      async function load(){
        const meta = await (await fetch('/api/runs/segments')).json();
        runsEl.innerHTML='';
        for(const r of (meta.runs||[])){
          const row = document.createElement('div');
          row.className='row';
          row.style.justifyContent='space-between';
          row.innerHTML = `<span class=\"small\">Run #${r.idx} · ${r.count} ev · ${r.errors} err · ${r.approvals} approvals ${r.runId?`· id=${r.runId}`:''}</span><span class=\"row\"><button class=\"pill\" data-act=\"open\">Open</button><button class=\"pill\" data-act=\"replay\">Replay</button><a class=\"pill\" data-act=\"kpi-json\" href=\"#\">KPI JSON</a><a class=\"pill\" data-act=\"kpi-csv\" href=\"#\">KPI CSV</a></span>`;
          row.querySelector('[data-act="open"]').onclick = async ()=>{
            let text = await (await fetch(`/api/runs/export/${r.idx}`)).text();
            text = highlightAgent(text, agentInput.value.trim());
            eventsEl.textContent = text;
            downloadEl.href = `/api/runs/export/${r.idx}`;
          };
          row.querySelector('[data-act=\"kpi-json\"]').onclick = (e)=>{ e.preventDefault(); if(!r.runId) return alert('runId missing'); window.open(`/api/kpi?window=24h&runId=${encodeURIComponent(r.runId)}`,'_blank'); };
          row.querySelector('[data-act=\"kpi-csv\"]').onclick = (e)=>{ e.preventDefault(); if(!r.runId) return alert('runId missing'); window.open(`/api/kpi?window=24h&runId=${encodeURIComponent(r.runId)}&format=csv`,'_blank'); };
          runsEl.prepend(row);
        }
      }
      document.getElementById('refresh').onclick = load;
      load();
      // Auto-open latest run when coming with agent param
      if(preAgent){ setTimeout(async ()=>{ const firstOpen = runsEl.querySelector('[data-act="open"]'); if(firstOpen) firstOpen.click(); }, 800); }
    </script>
  </body>
</html>
